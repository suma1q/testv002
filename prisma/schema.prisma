generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  
  // Subscription info
  plan          String    @default("free") // free, starter, professional, enterprise
  planStatus    String    @default("active") // active, cancelled, expired
  
  // Password reset
  resetToken        String?
  resetTokenExpiry  DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  accounts        Account[]
  sessions        Session[]
  invoices        Invoice[]
  quotations      Quotation[]
  subscription    Subscription?
  usage           Usage?
  documents       Document[] @relation("UserDocuments")
  billings        Billing[]
  payments        Payment[]
  posOrders       PosOrder[]
  taxLedgers      TaxLedger[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Invoice {
  id              String   @id @default(cuid())
  invoiceNumber   String   @unique
  userId          String
  
  fromName        String
  fromEmail       String
  fromAddress     String?
  fromCity        String?
  fromCountry     String?
  
  toName          String
  toEmail         String
  toAddress       String?
  toCity          String?
  toCountry       String?
  
  invoiceDate     DateTime
  dueDate         DateTime
  items           Json
  subtotal        Float
  tax             Float    @default(0)
  discount        Float    @default(0)
  total           Float
  
  notes           String?
  terms           String?
  
  status          String   @default("draft")
  pdfUrl          String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// NEW: Quotation Model
model Quotation {
  id              String   @id @default(cuid())
  quotationNumber String   @unique
  userId          String
  
  fromName        String
  fromEmail       String
  fromAddress     String?
  fromCity        String?
  fromCountry     String?
  
  toName          String
  toEmail         String
  toAddress       String?
  toCity          String?
  toCountry       String?
  
  quotationDate   DateTime
  validUntil      DateTime
  items           Json
  subtotal        Float
  tax             Float    @default(0)
  discount        Float    @default(0)
  total           Float
  
  notes           String?
  terms           String?
  
  status          String   @default("draft") // draft, sent, accepted, rejected, converted
  convertedToInvoiceId String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Subscription {
  id                  String   @id @default(cuid())
  userId              String   @unique
  lemonSqueezyId      String   @unique
  orderId             String
  name                String
  email               String
  status              String
  renewsAt            DateTime?
  endsAt              DateTime?
  trialEndsAt         DateTime?
  price               String
  isUsageBased        Boolean  @default(false)
  subscriptionItemId  String?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// NEW: Usage Tracking Model
model Usage {
  id              String   @id @default(cuid())
  userId          String   @unique
  
  // Monthly counters
  invoicesCount   Int      @default(0)
  quotationsCount Int      @default(0)
  
  // Reset tracking
  lastResetDate   DateTime @default(now())
  currentMonth    String   // Format: "YYYY-MM"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ===== UNIFIED DOCUMENTS & BILLING SYSTEM =====

// Document Model - unified for all document types
model Document {
  id                String   @id @default(cuid())
  documentType      String   // invoice, quotation, estimate, purchaseOrder, deliveryNote, creditNote, receipt
  documentNumber    String
  
  // From/To details
  fromName          String
  fromEmail         String
  fromAddress       String?
  fromCity          String?
  fromCountry       String?
  
  toName            String
  toEmail           String
  toAddress         String?
  toCity            String?
  toCountry         String?
  
  // Dates
  documentDate      DateTime
  dueDate           DateTime?
  validUntil        DateTime?
  
  // Items & Amounts
  items             Json     // Array of {description, quantity, rate, amount, tax}
  subtotal          Float    @default(0)
  tax               Float    @default(0)
  discount          Float    @default(0)
  total             Float    @default(0)
  
  // Metadata
  notes             String?
  terms             String?
  currency          String   @default("USD")
  template          String?  // template ID (Pro only)
  
  // Document status
  status            String   @default("draft") // draft, sent, accepted, rejected, converted, paid
  convertedFrom     String?  // reference to converted document ID
  pdfUrl            String?
  
  // Relations
  userId            String
  user              User     @relation("UserDocuments", fields: [userId], references: [id], onDelete: Cascade)
  billings          Billing[]
  posOrder          PosOrder? @relation("DocumentFromPosOrder")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([documentNumber, userId])
  @@index([userId])
  @@index([documentType])
  @@index([status])
}

model Billing {
  id                String   @id @default(cuid())
  documentId        String
  userId            String
  
  // Billing classification
  type              String   // income (invoice), expense (PO), refund (credit note), none
  billingStatus     String   @default("unpaid") // unpaid, partial, paid, refunded
  
  // Amounts
  amount            Float
  tax               Float    @default(0)
  total             Float
  paidAmount        Float    @default(0)
  remainingAmount   Float
  
  // GST/VAT tracking
  gstNumber         String?
  taxRate           Float    @default(0)
  taxId             String?
  
  // Meta
  reference         String?  // external reference
  notes             String?
  
  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  document          Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  payments          Payment[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([documentId])
  @@index([userId])
  @@index([billingStatus])
  @@index([type])
}

model Payment {
  id                String   @id @default(cuid())
  billingId         String
  userId            String
  
  // Payment details
  amount            Float
  method            String   // cash, bank, stripe, cheque, other
  status            String   @default("completed") // pending, completed, failed, refunded
  reference         String?  // txn ID, cheque number, etc.
  
  // Payment gateway metadata
  gatewayMeta       Json?    // Stripe session, webhook data, etc.
  stripePaymentIntentId String?
  
  // Receipt generation
  receiptId         String?  // Link to generated receipt document
  
  // Dates
  paidAt            DateTime @default(now())
  refundedAt        DateTime?
  
  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  billing           Billing  @relation(fields: [billingId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([billingId])
  @@index([userId])
  @@index([method])
}

// POS System Models
model PosOrder {
  id                String   @id @default(cuid())
  userId            String
  documentId        String?  @unique
  
  // Order details
  tableNumber       String?
  customerName      String?
  orderType         String   // dine-in, takeaway, room-service
  
  // Amounts
  subtotal          Float    @default(0)
  tax               Float    @default(0)
  discount          Float    @default(0)
  total             Float    @default(0)
  
  // Status
  status            String   @default("open") // open, held, checkout, closed
  
  // Payment
  paymentMethod     String?
  paymentStatus     String   @default("unpaid") // unpaid, paid, partial
  
  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items             PosOrderItem[]
  document          Document? @relation("DocumentFromPosOrder", fields: [documentId], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
}

model PosOrderItem {
  id                String   @id @default(cuid())
  posOrderId        String
  
  // Item details
  itemName          String
  category          String
  quantity          Int      @default(1)
  unitPrice         Float
  tax               Float    @default(0)
  amount            Float
  
  // Customizations
  notes             String?
  
  // Relations
  posOrder          PosOrder @relation(fields: [posOrderId], references: [id], onDelete: Cascade)
  
  @@index([posOrderId])
}

// Tax Ledger for reporting
model TaxLedger {
  id                String   @id @default(cuid())
  userId            String
  billingId         String?
  
  // Tax classification
  taxType           String   // GST, VAT, Sales Tax, etc.
  rate              Float
  taxableAmount     Float
  taxAmount         Float
  
  // Period
  taxPeriod         String   // YYYY-MM
  
  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  
  @@index([userId])
  @@index([taxPeriod])
}